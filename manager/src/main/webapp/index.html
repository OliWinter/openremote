<!DOCTYPE html>
<html>
<head>
    <title>OpenRemote Manager</title>

    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <link rel="icon" type="image/png" href="/static/img/favicon.png"/>

    <script src="/auth/js/keycloak.min.js"></script>

    <script>
        // TODO
        erraiBusRemoteCommunicationEnabled = false;

        function init() {
            var keycloakConfig = {
                url: '/auth',
                realm: window.location.pathname.split('/')[1],
                clientId: "or-manager"
            };
            window.keycloak = Keycloak(keycloakConfig);
            window.keycloak.init({onLoad: 'login-required'})
                    .success(function (authenticated) {
                        if (authenticated) {
                            loadApp();
                        } else {
                            window.keycloak.login();
                        }
                    })
                    .error(function () {
                        alert("Failed to initialize login. Please contact your administrator.");
                    });
        }

        function loadApp() {
            Promise.all([
                load.js("/static/bower_components/webcomponentsjs/webcomponents-lite.min.js"),
                load.css("/static/3rdparty/mapbox-gl-js/0.14.1/mapbox-gl.css"),
                load.js("/static/3rdparty/mapbox-gl-js/0.14.1/mapbox-gl.js"),
                load.js("/jsapi"),
                load.import("/static/css/style.html"),
                load.import("/static/components/ui/or-icons.html"),
                load.js("/static/gwt/Manager/Manager.nocache.js")
            ]).then(function () {
                console.log("Application resources loaded");
            }).catch(function () {
                alert("Error loading application resources. Service not available, please try again later.");
            });
        }

        var load = (function () {
            // Function which returns a function: https://davidwalsh.name/javascript-functions
            function _load(tag, rel) {
                return function (url) {
                    // This promise will be used by Promise.all to determine success or failure
                    return new Promise(function (resolve, reject) {
                        var element = document.createElement(tag);
                        var parent = 'body';
                        var attr = 'src';

                        // Important success and error for the promise
                        element.onload = function () {
                            resolve(url);
                        };
                        element.onerror = function () {
                            reject(url);
                        };

                        // Need to set different attributes depending on tag type
                        switch (tag) {
                            case 'script':
                                element.async = true;
                                break;
                            case 'link':
                                element.type = 'text/css';
                                element.rel = rel;
                                attr = 'href';
                                parent = 'head';
                        }

                        // Inject into document to kick off loading
                        element[attr] = url;
                        document[parent].appendChild(element);
                    });
                };
            }

            return {
                css: _load("link", "stylesheet"),
                import: _load("link", "import"),
                js: _load("script"),
                img: _load("img")
            }
        })();
    </script>

</head>
<body onload="init()" class="vbox viewport">

<iframe src="javascript:''"
        id="__gwt_historyFrame"
        style="position:absolute;width:0;height:0;border:0"></iframe>

<noscript>
    <div style="border: 1px solid red;">
        Your web browser must have JavaScript enabled
        in order for this application to display correctly.
    </div>
</noscript>

</body>
</html>